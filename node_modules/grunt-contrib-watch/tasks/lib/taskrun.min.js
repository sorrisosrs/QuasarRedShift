"use strict";var path=require("path");var EE=require("events").EventEmitter;var util=require("util");module.exports=function(grunt){var livereload=require("./livereload")(grunt);function TaskRun(target){this.name=target.name||0;this.files=target.files||[];this._getConfig=target._getConfig;this.options=target.options;this.startedAt=false;this.spawned=null;this.changedFiles=Object.create(null);this.spawnTaskFailure=false;this.livereloadOnError=true;if(typeof this.options.livereloadOnError!=="undefined"){this.livereloadOnError=this.options.livereloadOnError}}var getErrorCount=function(){if(typeof grunt.fail.forever_warncount!=="undefined"){return grunt.fail.forever_warncount+grunt.fail.forever_errorcount}else{return grunt.fail.warncount+grunt.fail.errorcount}};TaskRun.prototype.run=function(done){var self=this;if(self.startedAt!==false){return}self.startedAt=Date.now();self.spawnTaskFailure=false;self.errorsAndWarningsCount=getErrorCount();self.tasks=self._getConfig("tasks")||[];if(typeof self.tasks==="string"){self.tasks=[self.tasks]}if(self.tasks.length<1){return done()}if(self.options.spawn===false||self.options.nospawn===true){grunt.task.run(self.tasks);done()}else{self.spawned=grunt.util.spawn({grunt:true,opts:{cwd:self.options.cwd.spawn,stdio:"inherit"},args:self.tasks.concat(self.options.cliArgs||[])},function(err,res,code){self.spawnTaskFailure=code!==0;if(self.options.interrupt!==true||code!==130&&code!==1){self.spawned=null;done()}})}};TaskRun.prototype.complete=function(){var time=Date.now()-this.startedAt;this.startedAt=false;if(this.spawned){this.spawned.kill("SIGINT");this.spawned=null}var taskFailed=this.spawnTaskFailure||getErrorCount()>this.errorsAndWarningsCount;this.errorsAndWarningsCount=getErrorCount();if(this.livereload&&(this.livereloadOnError||!taskFailed)){this.livereload.trigger(Object.keys(this.changedFiles));this.changedFiles=Object.create(null)}return time};return TaskRun};