"use strict";var path=require("path");var fs=require("fs");var UglifyJS=require("uglify-js");var _=require("lodash");exports.init=function(grunt){var exports={};exports.minify=function(files,dest,options){options=options||{};grunt.verbose.write("Minifying with UglifyJS...");var topLevel=null;var totalCode="";var sourcesContent={};var outputOptions=getOutputOptions(options,dest);var output=UglifyJS.OutputStream(outputOptions);files.forEach(function(file){var code=grunt.file.read(file);totalCode+=code;var basename=path.basename(file);var fileDir=path.dirname(file);var sourceMapDir=path.dirname(options.generatedSourceMapName);var relativePath=path.relative(sourceMapDir,fileDir);var pathPrefix=relativePath?relativePath+path.sep:"";file=(pathPrefix+basename).replace(/\\/g,"/");sourcesContent[file]=code;topLevel=UglifyJS.parse(code,{filename:file,toplevel:topLevel,expression:options.expression})});if(options.wrap){topLevel=topLevel.wrap_commonjs(options.wrap,options.exportAll)}if(options.enclose){var argParamList=_.map(options.enclose,function(val,key){return key+":"+val});topLevel=topLevel.wrap_enclose(argParamList)}if(options.expression===false){topLevel.figure_out_scope()}if(options.compress!==false){if(options.compress.warnings!==true){options.compress.warnings=false}var compressor=UglifyJS.Compressor(options.compress);topLevel=topLevel.transform(compressor);topLevel.figure_out_scope()}if(options.mangle!==false){topLevel.mangle_names(options.mangle)}if(options.sourceMap&&options.sourceMapIncludeSources){for(var file in sourcesContent){if(sourcesContent.hasOwnProperty(file)){outputOptions.source_map.get().setSourceContent(file,sourcesContent[file])}}}topLevel.print(output);var min=output.get();if(options.sourceMap){min+="\n//# sourceMappingURL="+options.destToSourceMap.replace(/\\/g,"/")}var result={max:totalCode,min:min,sourceMap:outputOptions.source_map};grunt.verbose.ok();return result};var getOutputOptions=function(options,dest){var outputOptions={beautify:false,source_map:null};if(options.preserveComments){if(options.preserveComments==="all"||options.preserveComments===true){outputOptions.comments=true}else if(options.preserveComments==="some"){outputOptions.comments=/^!|@preserve|@license|@cc_on/i}else if(_.isFunction(options.preserveComments)){outputOptions.comments=options.preserveComments}}if(options.banner&&options.sourceMap){outputOptions.preamble=options.banner}if(options.beautify){if(_.isObject(options.beautify)){_.assign(outputOptions,options.beautify)}else{outputOptions.beautify=true}}if(options.sourceMap){var destBasename=path.basename(dest);var destPath=path.dirname(dest);var sourceMapIn;if(options.sourceMapIn){sourceMapIn=grunt.file.readJSON(options.sourceMapIn)}outputOptions.source_map=UglifyJS.SourceMap({file:destBasename,orig:sourceMapIn})}if(options.indentLevel!==undefined){outputOptions.indent_level=options.indentLevel}return outputOptions};return exports};