"use strict";var util=require("util");var hooker=require("hooker");var colors=require("colors");var _=require("lodash");_.str=require("underscore.string");_.mixin(_.str.exports());function Log(options){this.always=this;this.options=_.extend({},{color:true,verbose:false,debug:false,outStream:process.stdout,grunt:null,maxCols:null,muted:false},options);this.hasLogged=false;this.verbose=new VerboseLog(this,true);this.notverbose=new VerboseLog(this,false);this.verbose.or=this.notverbose;this.notverbose.or=this.verbose;if(this.options.grunt){_.bindAll(this);_.bindAll(this.verbose);_.bindAll(this.notverbose)}}exports.Log=Log;function VerboseLog(parentLog,verbose){this.always=parentLog;this._isVerbose=verbose}util.inherits(VerboseLog,Log);VerboseLog.prototype._write=function(){if(Boolean(this.option("verbose"))!==this._isVerbose){return}return VerboseLog.super_.prototype._write.apply(this,arguments)};function makeSmartAccessor(name,isOption){Object.defineProperty(Log.prototype,name,{enumerable:true,configurable:true,get:function(){return isOption?this.always._options[name]:this.always["_"+name]},set:function(value){if(isOption){this.always._options[name]=value}else{this.always["_"+name]=value}}})}makeSmartAccessor("options");makeSmartAccessor("hasLogged");makeSmartAccessor("muted",true);Log.prototype.initColors=function(){if(this.option("no-color")){colors.mode="none";hooker.hook(console,"log",function(){var args=_.toArray(arguments);return hooker.filter(this,args.map(function(arg){return typeof arg==="string"?colors.stripColors(arg):arg}))})}};Log.prototype.option=function(name){if(this.options.grunt&&this.options.grunt.option){return this.options.grunt.option(name)}var no=name.match(/^no-(.+)$/);return no?!this.options[no[1]]:this.options[name]};Log.prototype._markup=function(str){str=str||"";str=str.replace(/(\s|^)_(\S|\S[\s\S]+?\S)_(?=[\s,.!?]|$)/g,"$1"+"$2".underline);str=str.replace(/(\s|^)\*(\S|\S[\s\S]+?\S)\*(?=[\s,.!?]|$)/g,"$1"+"$2".bold);return str};Log.prototype._format=function(args){args=_.toArray(args);if(args.length>0){args[0]=String(args[0])}return util.format.apply(util,args)};Log.prototype._write=function(msg){if(this.muted){return}this.hasLogged=true;msg=msg||"";if(this.option("no-color")){msg=colors.stripColors(msg)}this.options.outStream.write(this._markup(msg))};Log.prototype._writeln=function(msg){this._write((msg||"")+"\n")};Log.prototype.write=function(){this._write(this._format(arguments));return this};Log.prototype.writeln=function(){this._writeln(this._format(arguments));return this};Log.prototype.warn=function(){var msg=this._format(arguments);if(arguments.length>0){this._writeln(">> ".red+_.trim(msg).replace(/\n/g,"\n>> ".red))}else{this._writeln("ERROR".red)}return this};Log.prototype.error=function(){if(this.options.grunt&&this.options.grunt.fail){this.options.grunt.fail.errorcount++}this.warn.apply(this,arguments);return this};Log.prototype.ok=function(){var msg=this._format(arguments);if(arguments.length>0){this._writeln(">> ".green+_.trim(msg).replace(/\n/g,"\n>> ".green))}else{this._writeln("OK".green)}return this};Log.prototype.errorlns=function(){var msg=this._format(arguments);this.error(this.wraptext(this.options.maxCols||77,msg));return this};Log.prototype.oklns=function(){var msg=this._format(arguments);this.ok(this.wraptext(this.options.maxCols||77,msg));return this};Log.prototype.success=function(){var msg=this._format(arguments);this._writeln(msg.green);return this};Log.prototype.fail=function(){var msg=this._format(arguments);this._writeln(msg.red);return this};Log.prototype.header=function(){var msg=this._format(arguments);if(this.hasLogged){this._writeln()}this._writeln(msg.underline);return this};Log.prototype.subhead=function(){var msg=this._format(arguments);if(this.hasLogged){this._writeln()}this._writeln(msg.bold);return this};Log.prototype.debug=function(){var msg=this._format(arguments);if(this.option("debug")){this._writeln("[D] "+msg.magenta)}return this};Log.prototype.writetableln=function(widths,texts){this._writeln(this.table(widths,texts));return this};Log.prototype.writelns=function(){var msg=this._format(arguments);this._writeln(this.wraptext(this.options.maxCols||80,msg));return this};Log.prototype.writeflags=function(obj,prefix){var wordlist;if(Array.isArray(obj)){wordlist=this.wordlist(obj)}else if(typeof obj==="object"&&obj){wordlist=this.wordlist(Object.keys(obj).map(function(key){var val=obj[key];return key+(val===true?"":"="+JSON.stringify(val))}))}this._writeln((prefix||"Flags")+": "+(wordlist||"(none)".cyan));return this};Log.prototype.wordlist=exports.wordlist=function(arr,options){options=_.defaults(options||{},{separator:", ",color:"cyan"});return arr.map(function(item){return options.color?String(item)[options.color]:item}).join(options.separator)};Log.prototype.uncolor=exports.uncolor=function(str){return str.replace(/\x1B\[\d+m/g,"")};Log.prototype.wraptext=exports.wraptext=function(width,text){var result=[];var matches,color,tmp;var captured=[];var charlen=0;while(matches=text.match(/(?:(\x1B\[\d+m)|\n|(.))([\s\S]*)/)){text=matches[3];if(matches[1]){color=matches[1];captured.push(matches[1]);continue}else if(matches[2]){if(charlen===0&&color){captured.push(color)}captured.push(matches[2]);charlen++;if(charlen<=width||matches[2]===" "){continue}tmp=captured.lastIndexOf(" ");text=captured.slice(tmp===-1?tmp:tmp+1).join("")+text;captured=captured.slice(0,tmp)}result.push(captured.join(""));captured=[];charlen=0}result.push(captured.join(""));return result.join("\n")};Log.prototype.table=exports.table=function(widths,texts){var rows=[];widths.forEach(function(width,i){var lines=this.wraptext(width,texts[i]).split("\n");lines.forEach(function(line,j){var row=rows[j];if(!row){row=rows[j]=[]}row[i]=line})},this);var lines=[];rows.forEach(function(row){var txt="";var column;for(var i=0;i<row.length;i++){column=row[i]||"";txt+=column;var diff=widths[i]-this.uncolor(column).length;if(diff>0){txt+=_.repeat(" ",diff)}}lines.push(txt)},this);return lines.join("\n")};