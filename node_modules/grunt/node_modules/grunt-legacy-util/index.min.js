"use strict";var spawn=require("child_process").spawn;var nodeUtil=require("util");var path=require("path");var util=module.exports={};util.namespace=require("getobject");util.hooker=require("hooker");util.async=require("async");var _=util._=require("lodash");var which=require("which").sync;util.exit=require("exit");_.str=require("underscore.string");_.mixin(_.str.exports());util.callbackify=function(fn){return function callbackable(){var result=fn.apply(this,arguments);var length=arguments.length;if(length===fn.length){return}var done=arguments[length-1];if(typeof done==="function"){done(result)}}};util.error=function(err,origError){if(!nodeUtil.isError(err)){err=new Error(err)}if(origError){err.origError=origError}return err};util.linefeed=process.platform==="win32"?"\r\n":"\n";util.normalizelf=function(str){return str.replace(/\r\n|\n/g,util.linefeed)};var kindsOf={};"Number String Boolean Function RegExp Array Date Error".split(" ").forEach(function(k){kindsOf["[object "+k+"]"]=k.toLowerCase()});util.kindOf=function(value){if(value==null){return String(value)}return kindsOf[kindsOf.toString.call(value)]||"object"};util.toArray=_.toArray;util.repeat=function(n,str){return new Array(n+1).join(str||" ")};util.pluralize=function(n,str,separator){var parts=str.split(separator||"/");return n===1?parts[0]||"":parts[1]||""};util.recurse=function(value,fn,fnContinue){function recurse(value,fn,fnContinue,state){var error;if(state.objs.indexOf(value)!==-1){error=new Error("Circular reference detected ("+state.path+")");error.path=state.path;throw error}var obj,key;if(fnContinue&&fnContinue(value)===false){return value}else if(util.kindOf(value)==="array"){return value.map(function(item,index){return recurse(item,fn,fnContinue,{objs:state.objs.concat([value]),path:state.path+"["+index+"]"})})}else if(util.kindOf(value)==="object"&&!Buffer.isBuffer(value)){obj={};for(key in value){obj[key]=recurse(value[key],fn,fnContinue,{objs:state.objs.concat([value]),path:state.path+(/\W/.test(key)?'["'+key+'"]':"."+key)})}return obj}else{return fn(value)}}return recurse(value,fn,fnContinue,{objs:[],path:""})};util.spawn=function(opts,done){var callDone=function(code,stdout,stderr){stdout=_.rtrim(stdout);stderr=_.rtrim(stderr);var result={stdout:stdout,stderr:stderr,code:code,toString:function(){if(code===0){return stdout}else if("fallback"in opts){return opts.fallback}else if(opts.grunt){return stderr||stdout}return stderr}};done(code===0||"fallback"in opts?null:new Error(stderr),result,code)};var cmd,args;var pathSeparatorRe=/[\\\/]/g;if(opts.grunt){cmd=process.execPath;args=process.execArgv.concat(process.argv[1],opts.args)}else{try{if(!pathSeparatorRe.test(opts.cmd)){cmd=which(opts.cmd)}else{cmd=opts.cmd.replace(pathSeparatorRe,path.sep)}}catch(err){callDone(127,"",String(err));return}args=opts.args||[]}var child=spawn(cmd,args,opts.opts);var stdout=new Buffer("");var stderr=new Buffer("");if(child.stdout){child.stdout.on("data",function(buf){stdout=Buffer.concat([stdout,new Buffer(buf)])})}if(child.stderr){child.stderr.on("data",function(buf){stderr=Buffer.concat([stderr,new Buffer(buf)])})}child.on("close",function(code){callDone(code,stdout.toString(),stderr.toString())});return child};